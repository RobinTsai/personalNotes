# netcat 的使用

```sh
# 端口扫描，n ip地址 no dns, v verbose, z 不发送数据只报告端口是否开放, w 秒级连接超时
nc -nvz -w3 183.20.29.234 1025-65534

# 连接到某个端口
nc localhost 8021

# 用 nc 监听（-l）服务器 16555 端口（openbsd 版本省略了 -p），接收 udp 消息（-u）
# traditional 版本必须加上 -p，否则会认为是一个 IP，然后发生错误
# 不指定端口时会自动分配端口，总是使用 -v 是一个好习惯
# -vv 比 -v 有更多信息，可看发了多少数据
nc -l 16555 -u -v

# 客户端使用 udp 方式发送消息
nc -u localhost 16555

# -k 使客户端断开后服务端不断开（仅 openbsd 版本支持 -k）
nc -l -k 16555 -u

# 文件传输
nc -l -p 8080 > image.jpg           # 服务端（默认由客户端断开连接）
nc 192.168.1.2 8080 < image.jpg     # 客户端（传输完成不会自动断开连接，服务端也就不会断开连接）
nc 192.168.1.2 8080 -N < image.jpg  # 客户端，碰到 EOF（传输完成）关闭连接
nc 192.168.1.2 8080 -q0 < image.jpg # 客户端，-q 0 指明在 EOF 的 0s 后断开连接

# -n 不要进行域名解析（有时候连接上发送第一个消息会延时，服务端用 -v 会发现出现一个域名解析的错误，域名解析会有一部分时间消耗）
nc -n -p 8080

# 开后门
/bin/nc.traditional -l -p 8080 -e /bin/bash # traditional 版本有 -e，openbsd 中删除了
mkfifo /tmp/f; cat /tmp/f | /bin/bash 2>&1 | /bin/nc.openbsd -l -p 8080 > /tmp/f # openbsd 版本中用管道实现后门

# nginx 代理
# 从 12345 端口获取到的任何信息转发到本地 4044 端口（一个提供 http 服务的端口），并将响应传回客户端
mkfifo /tmp/f; cat /tmp/f | /bin/nc.openbsd -l -p 12345 | nc localhost 4044 > /tmp/f    # 妙

# 简单的一个发 SIP 的例子，如果要用 cat file | nc... 需要先执行 unix2dos file 一下将换行字符改一下（不改能被 Wireshark 解析）
# 注意使用 -e，对 \r\n 进行解析（zsh 默认带了 -e）
echo -e 'INVITE sip:bob@example.com SIP/2.0\r\nTo: Bob <sip:bob@example.com>\r\nFrom: Alice <sip:alice@example.com>\r\nCSeq: 1 INVITE\r\nCall-ID: 1234567890\r\nMax-Forwards: 70\r\nContent-Length: 0\r\n\r\n' | nc -u 39.x.x.165 5474
```

- 监听端口： `nc -lp 8080`（只接受一次连接）
- 安全巨洞：`nc -lp 8080 -e '/bin/sh -i'`（之前可用，现在不可用了）
- 监听端口允许多次连接需要 openbsd-netcat 版本，gnu-netcat 版本做了修剪

## nc 版本切换

nc 有两个版本，`traditional` 版本是自带版本；`openbsd` 版本功能更强大。

可通过 `whereis nc` 查看本地中 nc。

```sh
❯ whereis nc
nc: /bin/nc.traditional /bin/nc.openbsd /bin/nc /usr/share/man/man1/nc.1.gz # 本地存在多个版本
```

本地应该有多个 cn 版本，如果没有，可能需要安装进一步安装

```sh
apt-get install -y netcat-traditional
apt-get install -y netcat-openbsd
```

通过定位可见 nc 默认使用的是 nc.traditional 版本：

```sh
❯ ll /bin/nc
lrwxrwxrwx 1 root root 20 Jun 24  2019 /bin/nc -> /etc/alternatives/nc
❯ ll /etc/alternatives/nc*
lrwxrwxrwx 1 root root 19 Feb  6 17:27 /etc/alternatives/nc -> /bin/nc.traditional # nc 默认使用次版本
lrwxrwxrwx 1 root root 39 Feb  6 17:27 /etc/alternatives/nc.1.gz -> /usr/share/man/man1/nc.traditional.1.gz
```

切换版本

```sh
sudo update-alternatives --config nc
```

## 使用指导

通过 `man nc.openbsd` 可查看具体的使用指导：

- C/S 模型（此 nc 中没有 -e 或 -c 选项，但你仍可以通过创建 fifo 的文件让客户端任意命令）
- 文件传输
- 对话
- 端口扫描（-z 选项使 nc 报告开放的端口，最好加 -v 开启详细信息）

### 使用 nc 发送一个 UDP 消息

```sh
echo -ne 'SIP_MESSAGE' | nc -u IP PORT
cat SIP_txt.file | nc -u IP PORT
```
