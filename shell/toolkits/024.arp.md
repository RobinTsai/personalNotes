# arp

## 概念

- ARP（地址解析协议）提供了 IP 地址到对应 MAC 的动态映射。
- MAC，Media Access Control Address，就是网络设备硬件地址，标识网络设备唯一身份的标识符。
- “动态”是指这个过程自动完成、过期（静态的可手动加）。
- ARP 工作在哪一层有些争议，教材上定义工作在网络层，引起其属于 TCP/IP 协议簇；而按 OSI 其工作在链路层，因为在封装 IP 包前需要通过 ARP 获取链路层目的地址加入包头。
- 以太网地址（以太网内的 MAC 地址）是 48bit，像 xx-xx-xx-xx-xx-xx 或 xx:xx:xx:xx:xx:xx 表示，x 代表 0~f，大小写皆可。
- 设备驱动程序不会检查 MAC 地址
- 帧类型：0x0806

## 工作流程

ARP 工作在发 IP 报文之前，假设 IP 报文是从 A -> B.

1. A 用子网掩码判断 B 是否和自己在同一网段，若是，下一跳即为 B；若不是，A 会找到出口网关 C 作为下一跳。下一跳记为 D
2. ARP 广播 ARP request 到本子网网络中所有设备询问 D 的 MAC 地址
3. 网络设备收到 ARP 请求后判断被询问者是否是自己，若是（只有 D），进行响应自己的 MAC 地址，若不是，直接忽略
4. A 收到 ARP reply，解包，将 MAC 地址写入 IP 包中，并投递出去（投递到 D，即目的 MAC）
5. D 收到 IP 包，解包，发现 IP 不是自己的，再进行 ARP 找到下一跳转发出去
6. 重复以上步骤，直到包达到目的端 B

注：

- 只有 ARP 正常回答后，TCP 报文段才能被发出去

## arp 命令

```sh
arp -a    # 列出本地所有 ARP 缓存
arp -a IP # 列出本地 IP 的 ARP 缓存
arp -s    # set 一个 ARP 缓存
arp -d    # del 一个 ARP 缓存
```

## RARP 逆地址解析协议

一般来说，系统引导可以从本地磁盘配置文件中读到 IP 地址，但无盘机，如 X 终端或无盘工作站，就需要用 RARP 获取 IP 地址。

- 帧类型 0x8035，请求操作代码 3，应答操作代码 4
- 请求是广播（broadcast），应答是单播（unicast）
