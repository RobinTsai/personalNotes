# traceroute

## ping 记录路由的限制

Ping 程序利用 ICMP 回显请求可以做 TCP/IP 系统的连通性测试。它可以利用 IP 首部记录经过的 IP，但有限制：

- 不是所有路由器都支持记录路由选项，对于某些路径不能查路由
- 接收端会从收到的 IP 首中提取所有信息，会将记录下来的 IP 地址翻一番返回
- IP 首部留给记录路由的空间有限，最多 9 个 IP

### Traceroute 原理

Traceroute 利用 ICMP 报文和 IP 首部的 TTL （生存周期）字段实现。

TTL 存在的目的是防止数据报在选路中无休止地流动，当某路由器收到 TTL 为 0 或 1 的 IP 数据报时（理论上不会收到 0 的），路由器会丢弃并向信源发一个 ICMP 表示超时的信息，其中就包含了本路由器的 IP 地址。

所以 Traceroute 的实现原理就是，第一次使用 TTL 1 的 IP 数据报得到第一个路由器 IP；然后发一个 TTL 2 的 IP 数据报得到第二个路由器 IP……以此类推可得到所有非目的主机的 IP 地址。

最终的目的主机是特殊的，因为他收到了发给自己的 IP 报，所以不会丢弃报文并产生 ICMP 报文，那怎么判断是否到达目的主机呢？

Traceroute 的 IP 报会携带一个 UDP 数据报给目的主机，当 UDP 数据报到达目的主机而端口未开时，则会响应“端口不可达”的 ICMP 报文。

### Traceroute 工作方式

如上所述，Traceroute 会利用 TTL 递增的方式传递一个 UDP 报进行测试。

对于每个 TTL 值，会发送 3 份数据，没收到一份 ICMP 报文会输出往返时间，若 5s 内未收到用 * 标记，然后发下一份数据报。

Traceroute 发送的 IP 报共 40字节，20字节为 IP 首，8 字节为 UDP 首，12 字节为用户数据。

注：Traceroute 检查出的路由不一定就是路径，因为每个 IP 报走的路径可能不一样，即便 IP 报连续也可能不一样。
