# 内存回收策略-过期键删除策略

redis 内存回收机制主要体现在两个方面

- **过期键如何删除**
- 内存溢出如何控制（淘汰策略）

> 还有一种我觉得应该也是，就是用在共享对象中的引用计数方式。

## 过期键删除策略

redis 用了两种方式

- 惰性删除：当访问到的时候判断是否过期并删除过期
- 定时任务删除：内部定时任务，默认 100ms 一次，一次随机检查20个键，若有 25% 过期则继续。
    - 快模式：最长运行 1ms
    - 慢模式：最长运行 25ms

> 理论层面还有另一种是每个键设置一个定时器，但这种方式对 cpu 不友好，所以不在 redis 中使用。

> 快模式和慢模式只是运行时长不同，内部删除逻辑相同。

### 惰性删除 + RandomKey 命令可能的阻塞

如果使用惰性删除，那么在主节点上进行 RandomKey 命令时，如果频繁命中已过期的键，那么就会频繁触发删除操作，导致有较长的一段时间执行命令。

如果从 slave 节点执行，由于 slave 不会主动删除过期键，但它会验证过期，如果过期就不会返回此数据，而是继续随机寻找，从而导致可能更严重的问题。

5.0 版本之后修复，方案：randomkey 在执行过程中最多执行 100 次。超过次数后直接退出。
