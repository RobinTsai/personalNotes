# 集群-故障恢复

当从节点通过 **内部定时任务** 发现自身复制的主节点进入客观下线时，将触发故障恢复流程。

> 通过 **内部定时器任务**！！！
> 这里需要个解释。

## 选举流程

1. 资格检查
    >  与主节点通信时间大于某阈值则不具备资格。阈值：`cluster-node-time*cluster-slave-validity-factor`（后者默认 10，即 10 个 cluster-node-time 没联系就没资格了）
2. 准备选举时间
    > **延迟触发机制**：每个节点判断触发选举时间是按排名通过一定规则生成的，排名越高的越早触发。**排名** 是按复制偏移量计算的。即复制偏移量越大的，排名越靠前，越最早触发选举。
3. 发起选举
    > 更新配置纪元，然后广播选举消息（FAILOVER_AUTH_REQUEST）
4. 选举投票
    > 只有持有槽的主节点才有资格选举（才会处理上述中的消息），每个节点会对收到的第一个消息进行回复（FAILOVER_AUTH_ACK）作为投票（选举领导者的过程）
5. 故障转移

> 为什么没有使用从节点进行选举：
>
> 从节点必须大于等于 3 个才能保证 N/2+1，这将导致节点资源浪费，使用持有槽的主节点的话，即便一个从节点也可以做故障恢复。


> 投票作废
> - 每个配置纪元代表一次投票周期
> - `cluster-node-timeout * 2` 的时间内没获得足够数量的投票，则本次选举作废，增加纪元开始下一轮

## 转移流程（恢复流程）

当某个从节点有 N/2+1 个选票是可以进行故障恢复。三个步骤：

- 取消复制变成主节点
- 向故障主节点撤销负责的槽（clusterDelSlot），并委派给自己（clusterAddSlot）
- 向集群广播自己的 pong 消息：通知所有节点变更信息（包含槽信息）

## 与哨兵下的不同

> 注意区分：集群的故障发现变成 客观下线 是通过 ping 消息传播信息记录到自己的 **下线报告链表** 中的，当判断半数以上主观下线后则为客观下线。和选举不一样，选举是通过

