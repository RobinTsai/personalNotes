# 复制

命令

```c
// 建立复制
slaveof {masterHost} {masterPort}
// 查看复制状态
info replication
// 断开复制，并成为主节点（不会丢失数据）
slaveof no one
```

注意：切主操作（从复制一个主切换到复制另一个主）会清空原数据。

从节点默认为只读模式 `slave-read-only=yes`，建议不要动。

## 拓扑

- 一主一从
- 一主多从
- 树状主从

**一主一从**

- 从节点用于主节点的故障转移
- 主节点不要开持久化，以提高性能
- 从节点上开启 AOF 保证数据安全
- 注意：主节点自动重启会丢失所有数据，如果这时候从服务依旧保持复制状态也会清空数据，所以需要先故障转移（或从节点 slaveof no one）后再重启主节点

**一主多从**

又称 星形拓扑结构。

- 多个从节点去处理耗时的读命令，可防止慢查询对业务的影响
- 主从同步信息可能会造成网络阻塞

**树状主从**

又称 树状拓扑结构。

- 从节点不但可以复制主节点数据
- 同时作为下层的主节点向下传递复制数据
- 有效降低主节点负载和 主从复制 的网络成本

## 建立复制过程

由 slaveof 命令触发

1. 保存主节点信息
2. 主从建立 socket 连接（失败会无线重连）
3. 发送 ping 命令（检测）
4. 权限验证
5. 同步数据集（psync 部分+全量）
6. 命令持续复制

> 旧版本通过 sync 实现。。。

