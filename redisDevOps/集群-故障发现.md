
# 集群-故障发现

## 注意点

> 注意集群和哨兵中的区别。

- 每个节点都保存了全量的节点信息。
- 只有 **负责槽的主节点** 才参与故障发现：
    - 从节点只进行对主节点的复制；
    - 没分配槽的主节点也不参与故障发现。


## 主观下线和客观下线

- 主观下线（pfail）：某个节点认为另一个节点不可用。
- 客观下线（fail）：达到阈值的多个节点认为某一个节点不可用

## 客观下线流程

- 主观下线
    > 集群中每个节点都会定期向其他节点发送 ping 消息，接收节点响应 pong 消息。一旦失败或超时，则 **主观下线**。
- 传播消息
    > 当某个节点 A 判定另一个节点 B 为主观下线后，会将 B 节点的状态在集群内传播。
- 接收消息
    > C 节点收到 B 节点下线的消息后，会将信息保存到本地下线报告链表（`clusterNode.list *fail_reports`）中。
- 验证是否符合客观下线
    > 每个节点收到 pfail 后都会检查是否半数以上都认为时主观下线，不符合则退出。
- 判定为客观下线
    > 当上步验证到半数以上持有槽的主节点都标记 B 为主观下线后判定为客观下线。
- 广播客观下线消息（fail 消息），此消息有两个重要职责：
    - 通知所有节点标记 B 为客观下线 **并立即生效**（消息中只包含故障节点 ID）。
    - 通知故障节点的从节点触发 **故障转移流程**
- 故障转移

> 对于误报的处理
>
> **下线报告链表** 中存储了下线状态的节点：**下线报告链表** 会一直维持更新，如果有 `2*cluster_node_timeout` 内没收到更新则会过期删除。所以如果 `cluster_node_timeout` 设置过小则可能永远无法完成故障转移。
>
>> Gossip 通信一节也说过： cluster_node_timeout 默认 15s。调大此参数可节省带宽；调小能加快故障转移、槽更新、新节点发现速度。

## 故障发现中集群与哨兵的不同点汇总

> 几乎一样。
> 都通过 Gossip 协议通信。

- 参与节点不同：
    - 集群中只有 **负责槽** 的 **主节点** 参与故障发现；
    - 哨兵中 sentinel 参与。
- 判断客观下线的逻辑不同
    - 哨兵是询问的方式。`is-master-down-by-addr`
    - 集群是传播消息的方式。