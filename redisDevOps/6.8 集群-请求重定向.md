# 集群-请求重定向

重定向有两种：

- MOVED 重定向：访问目标节点中不存在此槽位（不存在或已迁移）
- ASK 重定向：槽位正在迁移，此节点没有，访问另一个试试 

## 请求路由重定向：访问已经迁移到另一个节点的槽位

场景：节点不记录此槽位或已经迁移到另一个节点，收到对此槽的访问命令。

集群模式下，redis-cli 直连了一个节点，而没用 -c 参数连接整个集群收到命令：

- 计算哈希找到对应槽位。（用 `{hash_tag}`，若无则用全部的 key）
- 根据槽找到对应节点。（Gossip 消息交换获取到每个节点的槽信息，存储在 clusterState.slots[] 中）
- 若节点是自身，直接处理；
- 若节点不是自身，返回 MOVED 重定向错误。（`(error) MOVED 9252 127.0.0.1:6380`）
- (客户端需要自己通过 MOVED 信息访问正确的节点)

如上，节点对于不属于自己的键命令只回复重定向响应，不负责转发。
redis-cli 在使用 -c 参数后会收到 MOVED 后再次转发请求。

## ASK 重定向：访问正在迁移的槽位

场景：节点正在迁移当前槽（如 4096槽，部分在 A 节点部分在 B 节点），此时此槽收到客户端访问命令。

与 MOVED 区别：
- 返回 MOVED 是节点确认此槽在另一个节点中（可能是刚迁移完，也可能是本来就每分配到这个节点）；
- 返回 ASK 是节点正在迁移此槽，所以此 key 可能在此节点，也可能在另一个节点上。

命令过程：
- 节点收到请求，正在迁移
- 查询键对象是否存在，若存在直接正常返回
- 键不存在，查找槽是否正在迁出，若是则响应 ASK 异常（否则略）。（`(error) ASK {slot} {targetIP:port}`）
- 客户端执行 ASKING 命令。（注意是 `ASKING` 命令，此命令只是打开了一个标识，用于下次命令的携带）
- 客户端发送原命令到 targetIP。（发送时携带了 ASKING 标识，发送完后此标识会被重置）

## Smart 客户端

一些客户端支持集群协议，参考 https://redis.io/clients/

Smart 客户端在客户端侧维护了 slot->node 的映射关系，本地就可以确定节点。

查找槽位到节点映射的命令：

```sh
# 对集群任一节点可访问，返回槽位到节点的映射
cluster slots
```

## 多节点