# 运维技巧

- `redis-cli monitor | tee > /tmp/redis_monitor.log` 命令可以查看当前 redis 在执行什么命令。慎用，内存风暴风险。
- `redis-cli slowlog len` 查看 slowlog 条数
- `redis-cli slowlog get 129 > slow-129.log` 将 slowlog 导出最近的 129 条

## 问题记录

### scan 并发量大导致 CPU 占用 100%

命令：`scan INDEX match XXX:* count N`

关键现象：
- 流量偏移到 redis master 节点
- CPU 很高期间慢查询日志有 scan 操作，起止时间与 CPU 飙高时间差不多

原因：业务中有多个 SCAN 命令并发跑，导致流量偏移到 master 并 CPU 飙升。

[参考](https://zhuanlan.zhihu.com/p/381813397)

### sentinel 信息异常令人疑惑

在线上某个 sentinel 中执行 `info sentinel` 出现

```sh
10.11.54.187:26372> info sentinel
# Sentinel
sentinel_masters:1
...
master0:name=mymaster,status=sdown,address=10.11.54.187:6704,slaves=2,sentinels=4
```

其实只有三个 sentinel 监听这个集群，但为什么 sentinels=4 呢？

这是因为 sentinel 配置文件中记录有三个 `sentinel known-sentinel` 记录，所以加上自己是 4 个。我们知道 sentinel 每查找 peer 后，会向自己的配置文件中追加 peer 的信息，所以这里可以推导出在历史中此配置文件添加了其他三个 sentinel。

# 安装

- 从 https://download.redis.io/releases/ 中下载对应版本
- tar -zxvf xxx.tar.gz 解压
- 进入解压后 src 目录，执行 `make install PREFIX=/usr/local/redis` 指定安装目录
