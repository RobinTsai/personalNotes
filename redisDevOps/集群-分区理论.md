# 集群-分区理论

## 分区方案

- 客户端分区方案，有客户端控制分区，优点逻辑可控，缺点需要自己处理路由、高可用、故障转移
- 代理方案，加代理，优点客户端逻辑简单，缺点加大部署复杂度
- 查询路由，客户端随机地请求任意一个redis实例，然后由服务端转发给正确的分区节点

> Redis Cluster实现了一种混合形式的查询路由，当路由错误时不会直接将请求转发到正确节点，而是返回给客户端正确节点的信息，由客户端配合访问正确的节点。

## 分区规则

- 节点取余分区。简单，但需要翻倍扩容
- 一致性哈希分区。哈希环，数据倾斜问题
- 虚拟槽分区，16384 个槽，每个节点负责指定量的槽

数据倾斜：一致性 Hash 算法在服务节点太少时，容易因为节点分部不均匀而造成数据倾斜（被缓存的对象大部分集中缓存在某一台服务器上）问题。

## Redis 分区

Redis 采用虚拟槽分区。

- 计算槽：slot = CRC16(key) & 16383
- 找到节点（节点自身维护了槽信息）