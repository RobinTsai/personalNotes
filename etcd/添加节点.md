# 添加节点操作流程


## ETCD 添加节点执行操作的整体策略

1. 集群中三个 etcd 服务，先上线一个新的 etcd 服务（加入集群并启动成功），然后下线一个旧的，再次重复一次以使三个服务分布到三台机器上。
2. 两台新机器一个是从机器 sh-xcc1-etcd01 镜像来的，所以可以在两台新机器上 **分别** 用 /usr/local/etcd 下 etcd2、etcd3 目录



## 预备命令检查信息

依次执行，记录并观察结果：

export ETCDCTL_API=3 # 设置变量
etcdctl --endpoints="http://10.11.54.187:2379,http://10.11.54.187:2389,http://10.11.54.187:2399" member list
etcdctl --endpoints="http://10.11.54.187:2379,http://10.11.54.187:2389,http://10.11.54.187:2399" endpoint status --write-out=table
etcdctl --endpoints="http://10.11.54.187:2379,http://10.11.54.187:2389,http://10.11.54.187:2399" endpoint health --write-out=table

获取信息：那个 etcd 是主节点（0921日是 infra1）、另外两个节点的 ID、 PEER_URL 信息
获取主机 IP 信息： ifconfig eth0


## 集群加节点

准备好 NEW_NAME 和 PEER_URL 执行：
etcdctl --endpoints="http://10.11.54.187:2389" member add {NEW_NAME} --peer-urls="http://{NEW_PEER_HOST:NEW_PORT}"

（可以收集返回的信息，填充到下方脚本中，尤其是 ETCD_INITIAL_CLUSTER 比较长）

---

查看节点列表、状态（注意 endpoints 的变化）：
etcdctl --endpoints="http://10.11.54.187:2379,http://10.11.54.187:2389,http://10.11.54.187:2399" member list
etcdctl --endpoints="http://10.11.54.187:2379,http://10.11.54.187:2389,http://10.11.54.187:2399" endpoint status --write-out=table
etcdctl --endpoints="http://10.11.54.187:2379,http://10.11.54.187:2389,http://10.11.54.187:2399" endpoint health --write-out=table

---

修改脚本 launch.sh

- 用获取到的 IP 信息替换 LOCAL 变量
- 更换 NAME 就是上条命令中的 NEW_NAME
- 将上条命令的结果 ETCD_INITIAL_CLUSTER 更换下方的 EPS_WITH_NAME
- 确认 \*\_DB\_PATH 的目录（etcdN 的变更)
- （有增删后需要进行的操作）将 EPS_WITH_NAME 更换为已运行节点的信息，注意格式保持
- 注：log 文件可以不变更
- 注：删除原数据文件 /usr/local/etcd/etcdN/ 下的 data 和 wal （sudo）

```sh
#!/bin/bash

LOCAL=10.11.54.187
NAME=infra2
CUR_PEER_URL=http://${LOCAL}:2368
CUR_CLI_URL=http://${LOCAL}:2379

EPS_WITH_NAME=infra0=http://10.11.54.187:2388,infra1=http://10.11.54.187:2378,infra2=http://10.11.54.187:2368

DATA_DB_PATH=/usr/local/etcd/etcd3/data
WAL_DB_PATH=/usr/local/etcd/etcd3/wal

etcd --name ${NAME} \
  --data-dir=${DATA_DB_PATH} \
  --wal-dir=${WAL_DB_PATH} \
  --auto-compaction-retention=1m \
  --snapshot-count=5000 \
  --quota-backend-bytes=$((6*1024*1024*1024)) \
  --initial-advertise-peer-urls ${CUR_PEER_URL} \
  --listen-peer-urls ${CUR_PEER_URL} \
  --listen-client-urls ${CUR_CLI_URL} \
  --advertise-client-urls ${CUR_CLI_URL} \
  --initial-cluster-token etcd-cluster-1 \
  --initial-cluster ${EPS_WITH_NAME} \
  --initial-cluster-state existing > /var/log/etcd/etcd3.log 2>&1
```

---

执行脚本： sudo nohup ./launch.sh &

查看日志： /var/log/etcd/etcd.log

查看节点列表、状态（注意 endpoints 的变化）：
etcdctl --endpoints="http://10.11.54.187:2379,http://10.11.54.187:2389,http://10.11.54.187:2399" member list
etcdctl --endpoints="http://10.11.54.187:2379,http://10.11.54.187:2389,http://10.11.54.187:2399" endpoint status --write-out=table
etcdctl --endpoints="http://10.11.54.187:2379,http://10.11.54.187:2389,http://10.11.54.187:2399" endpoint health --write-out=table

查看状态期望正常

---

下线一个旧 etcd 服务：
执行命令： etcdctl --endpoints="http://10.11.54.187:2389" member remove <OLD_ID>
