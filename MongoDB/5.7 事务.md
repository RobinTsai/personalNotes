# 事务

版本历史：
- 3.6 单文档事务
- 4.0 复制集下事务
- 4.2 分片集群下事务

## 基本原理

ACID 略

- 脏读
- 不可重复读
- 幻读

Mongodb 支持的隔离级别

- 读未提交
- 读已提交
- 快照隔离（可能出现幻读）

事务相关数据结构（WT_TXN）

- 事务 ID，事务的全局唯一标识
- snapshot_data，快照信息，如 snap_min、snap_max 两个属性计算出一个事务开始时的数据范围

> 每个事务开启时，就会进行一个快照（Mysql）

## Snapshot 隔离

> Mongodb 默认选择此种 隔离级别。

原理：
- 事务开始时，创建快照
- 从提交的事务中获取 **文档** 的版本数据信息
- 可见数据为已提交事务的修改版本
- （流程中不会看到 事务 ID 大于 snap_max 事务修改的数据）

## MVCC 并发控制

> Snapshot 用于并发读问题，MVCC 用于并发写问题。MVCC 相当于一种**乐观锁机制**。

MVCC 在内存中维护了一个多版本的 **行数据**（leaf page 上的 WT_UPDATE 结构），针对于同一 行记录 以不同行版本号的形式存下来，从而实现事务的并发写。

当冲突时，会报错（事务内）。

## 事务日志 Journal

Journal 时一种 WAL（Write Ahead Log）事务日志。

目的：实现事务提交层面的持久化，保证一致性。

和 checkpoint 区分：
- checkpoint 是针对于内存中已经修改的数据落盘后，将数据文件发生的变化保存到 checkpoint 元数据文件中。
- Journal 持久化的对象不是修改的数据，而是修改的动作，一日至保存到日志缓存中，在根据周期等规则落盘到日志文件。
- 关键：Journal 是永远在 checkpoint 后的数据变化的持久化

> 上述“Journal 是永远在 checkpoint 后的数据变化的持久化”的解释：
> 数据库意外故障恢复时，首先会进行检查最近 checkpoint 信息，按 checkpoint 进行恢复，然后再利用 Journal 完成剩下数据的恢复。（当然你需要开启 Journal，并配置一定的同步磁盘规则）

落盘规则：
- 周期，默认 50ms 一次。
- 提交写操作写关注（j:true）强制同步磁盘。
- 事务日志达到 100MB
