# 分片集群

- 海量存储
- 高效读写海量数据

架构：
- 分片 shard。
- mongos 路由。不存数据，只做路由。
- config 配置服务器。存数据专用，需要冗余备份（复制集）。

分片实质：
- 插入：按一定规则分散存储到集群的各分片上
- 查询：按一定规则查到所在分片，查数据

关键：片键的选择，一个字段或多个字段
- 影响集群读写性能
- 影响集群的数据分布
- 片键必须是索引键


分片命令：
```
sh.shardCollection("crm.customers", {city: 1})
// 是 crm.customers 集合按 city 分片
```

正确关闭集群（否则可能会丢失数据）：
- 关闭路由 mongos
- 关闭所有分片（先 Secondary 后 Primary）
- 关闭所有配置服务器（同样先 Secondary 后 Primary）

正确开启集群（否则内部节点通信会有有问题）：
- （与上方关闭相反。）
- 启动 配置服务器
- 启动 所有分片
- 启动 mongos 实例

## 片键的选择策略

考虑的问题：


策略：
- 基于 Hash 分片。太过分散，不适合范围查询，适合单点查询。但均匀。
- 基于 范围 分片（默认）。

## Chunk

- Mongodb 中分片集群数据的分割是以 Chunk 为单位进行的。
- 后台均衡器进程（Balancer）负责 chunk 的维护（分割、迁移等），无须人工干预。
- Chunk 默认 64M，过大可能分布不均，过小分割和迁移频繁

手工干预 Chunk 分割：
- 平均拆 `sh.splitFind()`。指定查询记录查到对应的 chunk 后，平均拆。
- 按位置拆 `sh.splitAt()`。指定查询条件的第一个记录进行拆。