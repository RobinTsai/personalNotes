# 索引

## 文件系统和索引

文件系统将磁盘抽象为 4 部分：引导块、超级块、索引节点表、数据块。

- **索引节点表** 存储了文件名或目录对应的 inode 节点。
- 索引也是以文件的方式存储在磁盘上的。

查询过程：

- 1. 通过文件名或目录找到 inode 节点
- 2. 通过 inode 节点定位文件数据在文件中的 **逻辑块号**
- 3. 磁盘驱动程序将 逻辑块号 映射到 磁盘上具体块号

## 索引原理

MongoDB 同样使用 B+ 树实现索引（很多八股文说是 B 树，属于误传）。
- 根节点
- 内节点：只保存索引字段的键值
- 叶子节点：保存索引键值及一个指针变量指向具体文档记录地址

特点：
- 每个叶子节点深度相同，通常为 3 层或 4 层
- 第一层节点和第二层节点几乎总是被加载到内存。所以 IO 次数一般仅一二次
- 叶子节点通过双向链表进行连接，且已排序。所以范围查询会遍历链表
- 不断插入数据会造成节点由下向上的索引拆分。索引节点的拆分和移动会非常耗时

> 再见 WiredTiger 存储引擎 一节。

## 创建索引

升序、降序、文本索引 text、地理位置索引 geospatial、Hash 索引 hashed

- 单字段索引
- 多字段索引（复合索引）
- 数组多键索引。会为数组的每一个元素创建索引
- 索引覆盖查询。（投射，只用到索引，不用 IO，高效）
- 全文索引（文本索引）。一个几何上最多只能一个文本索引，文本索引占用空间巨大，暂不支持中文。
- 地理位置索引。索引类型：2dsphere（球面空间索引）、2d（二维平面空间索引）。GeoJSON type：Point（坐标点）、LineString（一条线）、Polygon（多边形）
- Hash 索引：均匀分布、只支持单点查询
- TTL 索引。指定时间文档自动删除，也可以根据某字段指定相对时间
- 稀疏索引：只对某字段非空创建索引
- 部分索引：指定某字段的值进行索引

## 查询计划分析

- COLLSCAN：进行的全表扫描
- IXSCAN：表示查询使用了索引
- inputStage 是嵌套结构，是由内向外依次执行的过程
- totalKeysExamined：是索引检查键的数量（注意是 Keys 关键字）
- totalDocsExamined：是集合中检查键的数量（注意是 Docs 关键字）