# Sofia Gateway

> 本节可参考官方文档 [Soifa-Sip-Stack](https://freeswitch.org/confluence/display/FREESWITCH/Sofia+SIP+Stack) 一节。

## 相关命令

- Reload/Add profile/gateways

```
sofia profile <profile_name> [<rescan>|<restart>] reloadxml
```

- List gateways by status

```sh
sofia profile <profile> gwlist [up]|down # 需要开启心跳检测（ping 配置），成功 up，失败 down
```

- Delete gateways

```sh
sofia profile <profile_name> killgw <gw_name>|_all_
```

## Gateway 配置

首先 在 `conf/sip_profiles/*.xml` 中用 `<gateways>` 标签引入了 gateway，我们可以在引入的文件中加入 gateway 配置，关键字段如下：

```xml
<gateway name="gw1">
    <param name="realm" value="172.16.221.170:5080"/>
    <param name="username" value="1234"/>
    <param name="password" value=""/>

    <param name="register" value="false"/>
    <param name="ping" value="25"/>
</gateway>
```

- realm: 是 dialstring 中 @ 后面的表示，表示一个
- username/password: 可以不用填（因为一般不去注册，ACL？？）
- register: 是否开启注册请求
- ping: 心跳检测周期（options 请求）

然后需要配置 dialplan 需要将某种规则的拨号从 gateway 转出去：

```xml
<extension name="extension-intercom">
    <condition expression="^8(10[01][0-9])$" field="destination_number">
        <action application="set" data="dialed_extension=$1"/>
        <!-- <action application="export" data="sip_auto_answer=true"/> -->
        <action application="bridge" data="sofia/gateway/gw1/${dialed_extension}"/>
        <!-- <action application="bridge" data="user/${dialed_extension}@${domain_name}"/> -->
    </condition>
</extension>
```

- 如上，这里设置了前缀输入 8 紧接 对方号码 时，转到 `sofia/gateway/gw1/${dialed_extension}`

如上，拨通呼叫，另一个 FS 就可以正常接通了。
