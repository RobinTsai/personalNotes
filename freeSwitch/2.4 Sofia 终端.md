# Sofia 终端

Sofia 是个 SIP 的协议栈，它代表着一个完整的用户端（User Agent）控制着信令协议和呼叫处理过程中的媒体流。

在 FreeSWITCH 中 Sofia 作为一个模块 mod_sofia 引入，配置入口为 `conf/autoload_configs/sofia.conf.xml`。

## Profiles

[参考官网介绍](https://freeswitch.org/confluence/display/FREESWITCH/Configuring+FreeSWITCH#ConfiguringFreeSWITCH-SIPProfilessip-profiles)

Sofia 提供了 Profiles 的概念 ，每个 Profile 唯一绑定一对 IP 地址和端口号。它帮助 FreeSWITCH 路由不同类型的呼叫。

FreeSWITCH 默认提供了两个 Profile： Internal 和 External，当然可以自己在添加一些 profiles

- Internal 提供了和本地局域网内注册到 FS 的设备进行交互，默认绑定在 5060 端口
- External 提供了和外网入 PSTN 网关或 “SIP Trunk” 进行交互，默认绑定在 5080 端口

配置文件中关注以下几个配置，这些配置指明了 当前 profile 绑定的 IP 和 端口，以及收到呼叫后路由到的 dialplan 类型和 context：

```xml
<profile name="internal">
    <settings>
        <param name="sip-ip" value="$${local_ip_v4}"/>
        <param name="sip-port" value="$${internal_sip_port}"/>
        <param name="context" value="public"/>
        <param name="dialplan" value="XML"/>
        <!-- ... -->
    </settings>
</profile>
```

## 相关命令

- View SIP regs

```sh
sofia xmlstatus|status profile <profile_name> reg
```

- 主动删除某一个注册的用户

```
sofia profile <profile> flush_inbound_reg call_id|user@host
sofia profile internal flush_inbound_reg bac1c125b6244c83aa021a17b0ca42b4
```
