# 从配置文件看工作流程

配置文件的拨号计划又叫 XML DialPlan，下文还会讲到 内联拨号计划。

拨号计划默认用 XML 格式配置。DailPlan 的完整结构的配置是这样的嵌套结构（简写了 xml 文件）：

```yml
- document
  - section(name: dialplan)
    - context
      - extension # extension 与 extension 之间在逻辑上是隔离的
        - condition(field="xxx" expression="^echo|1234$") # 测试条件，指定表达式
          - action(application="info" data="xxx") # 执行动作
```

- 修改配置文件后要用 `reloadxml` 命令或 F6键 重载配置文件
- DailPlan 的匹配顺序是按先后顺序进行匹配的，所以注意（不清楚整体情况时）自己修改的放到前面
- 注意修改权限，我在 sublime 中修改保存成功但实际 reloadxml 不成功，在整个文件夹的上加修改权限后成功
- 按 F8 或 `console loglevel debug` 设置 console 的 log 级别为 debug
- `extension` 标签有个 `continue="true"` 属性，表示匹配完当前 extension 后还可以匹配后方的 extension，默认 continue 为 false。
- `condition` 标签，为空表示匹配所有条件
  - 验证用户信息的 field（可以是内置变量，用户目录中的外置变量要用 `${}`）与 expression（正则）是否匹配
  - `condition` 标签可叠加，表示与关系
  - `condition` 标签中 `break` 参数可以做逻辑判断，如 `break="on-true"` 表示 **在执行完本 cond 中的 action 后** `if cond is true break`，另外有 on-false（默认），always，never (`whatever cond T/F never break`)
- `action` 标签是执行动作，`application` 表示设置执行的应用，`data` 为传进去的字段，现知的应用有：
  - info：输出所有变量到日志中
  - answer：接听电话，相当于 FS 响应应答消息，后面可以设置一些媒体流如放音、转到语音信箱等。
  - echo（数字号码 9196）：回声，可以听到自己的声音，另外还有个延迟回声 `delay_echo（9195）`。
  - log：输出日志，
  - hangup：挂断电话
  - set：设置一个当前 leg 的变量绑定到 Channel 上。如设置 greeting 变量的 data：`data="greeting=good-morning.wav"`
  - export：设置一个双方 leg 的变量，同时还设置一个 `export_vars=greeting`，当 data 开头为 `nolocal:` 时表示只设置到对方 leg 上。
  - hash：设置变量到内存哈希表中，data 的格式为 `operator/key/scope/value`
  - bridge：作用，将两条腿桥接起来（在这里创建 b-leg），data 是标准的呼叫字符串（Dial string），内部 `{c=d}` 可以设置 b-leg 的通道变量 c = d 。birdge 会一直阻塞等待 b-leg 接听或挂机等操作。
  - sleep：表示暂停的 ms 数
  - conference，会议，可以配置 condition 将呼叫某一（类）号码的用户都转到会议中（会议分组看 data 格式）。
  - bind_meta_app，根据用户输入的 number（加星号）执行操作。
  - transfer，将当前通话重新转移到 Routing 阶段。
  - playback（9664），播放一个声音文件
  - record，开启录音，data 中传保存位置

```xml
<extension name="My Echo Test"> <!-- 测试时名字没改，忽略其意义就好 -->
    <condition expression="^1234(\d+)$" field="destination_number">
        <action application="log" data="INFO you called ${destination_number}"/> <!-- log 数据首单词可设置级别 -->
        <action application="log" data="NOTICE the suffix is $1"/>
        <action application="hangup"/>
    </condition>
</extension>
```

![image.png](https://upload-images.jianshu.io/upload_images/3491218-7d714be65d316bde.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- 注意执行阶段，解析阶段，执行阶段
- 日志级别：CONSOLE、ALERT、CRIT、ERR、WARNING、NOTICE、INFO、DEBUG
- 反动作标签 `anti-action`，当 condition 不匹配时可以执行 **内部** 的 `anti-action` 标签（神奇的设定）。
