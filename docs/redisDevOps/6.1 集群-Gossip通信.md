# 集群-Gossip通信

通信使用 P2P 的 Gossip 协议。

Gossip 协议优缺点

- 优：天然分布性。
- 缺：频繁信息交换的网络成本和 CPU 成本。

## 通信流程

原理：节点之间不断地交换信息，一段时间后所有节点都知道了完整的信息。

过程：
- TCP 通道：基础端口 + 10000
- ping 消息，固定周期，特定几个节点
- pong 消息响应

不断通过 ping、pong 获取到所有节点的信息：节点故障、新进节点、主从变化、槽变更等。

## 协议消息

四种：

- ping 消息。发送自身和部分节点信息。
- pong 消息。作为响应返回自身节点信息。
- meet 消息。通知新节点加入。
- fail 消息。广播集群内节点下线。

## 节点选择

> Gossip 协议是 P2P 的，P2P 有一定的网络成本，数据量传输的过多会造成网络负担过重，传输的少影响故障判定、新节点发现。

Redis 中 Gossip 协议选择部分信息进行交换，且用固定频率每 100ms 一次，兼顾了信息的实时性和成本开销。

选择 ping 目标节点规则：

- 固定频率，100ms 一次
- 每秒随机 5 个节点中找出最久没通信的
- 选择通信间隔大于 node-timeout / 2 的

> cluster_node_timeout 默认 15s。调大此参数可节省带宽；**调小能加快故障转移、槽更新、新节点发现速度。**

ping 消息携带信息规则：

- 节点自身信息
- 默认携带 1/10 的其他节点（还有一些规则）