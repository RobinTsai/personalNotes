# 哨兵

三大块：

- [监控](./%E5%93%A8%E5%85%B5-%E7%9B%91%E6%8E%A7.md)
- [选举](./%E5%93%A8%E5%85%B5-%E9%80%89%E4%B8%BE.md)
- [故障转移](./%E5%93%A8%E5%85%B5-%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB.md)

## 存在的原因

主从复制缺点：
- 单点故障 + 人工干预 
- 压力限制
- 存储限制

问题一使用 哨兵
问题二三使用 集群

## 作用

故障自发现 + 故障转移

## 三个定时任务监控

- 每 10s 向主和从发 info 获取拓扑结构
- 每 2s 向 \_\_sentinel__:hello 发送主节点信息。交换信息
- 每 1s 向主、从、其他 sentinel 发 ping 心跳检测

## 主观下线和客观下线

当本哨兵每秒的 info 信息超时时，会认为是主观下线。然后通过 is-master-down-by-addr 命令向其他节点询问。

当超过 quorum 个数的哨兵认为下线时为客观下线，然后开始准备后续选取领导者并下线处理

## 领导者选举

- 每个哨兵结点都有资格称为领导者，当发送 is-master-down-by-addr 命令时就要求其他节点将自己设置为领导者
- 某个哨兵第一次收到此命令后会同意该请求，后续请求将拒绝
- 如果某哨兵得到的票数已经大于等于 quorum（半数以上），那么它将成为领导者，否则进入下一轮选举

## 故障转移

哨兵领导者将进行故障转移

- 剔除不健康的的（包含下线的、断线的、响应超时的）
- 按 slave-priority 选最高的从节点，若无，继续
- 按复制偏移量最大的进行选择
- 按 runid 最小的进行选择

> zk 是通过 3888 端口两两通信进行选举的。redis 是通过发布订阅实现故障转移的（来自 redis devops）。

生效过程

- 向候选主节点执行 slaveof no one 成为主节点
- 向剩余从结点发送命令让他们成为新主节点的从节点
- 将原来的主节点更新为从节点，并保持关注，恢复联系后成为新主节点的从结点

## 哨兵存在的问题

- 无法解决访问压力和存储压力的问题：单点存储了所有数据，写请求在单节点上
- 故障转移之间，服务完全无法提供服务

集群

- 分片，缓解了写请求压力和存储压力
- 故障转移，部分节点可用

---

问：哨兵模式下命令是哨兵接收的吗？