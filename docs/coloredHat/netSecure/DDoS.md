# DDoS

## 简介

DoS，Denial of Service，拒绝服务攻击，可以是单台机器的攻击，能力有限。

DDoS，是分布式的（Destributed），可能成千上万的网络设备同时对目标发起 DoS 攻击。发起攻击的网络被称为“僵尸网络”，发起攻击的每一台僵尸设备可以是任何智能设备。

僵尸网络形成的方式：

- 技术人士用后门、病毒等方式感染大量设备，形成网络；
- 烧钱。

- 互联网通信过程
- DDoS 攻击手段
- DDoS 治理和缓解

## 常用攻击方式

- 应用层（HTTP）：攻击目标机计算资源和 IO 资源。
- 传输层（TCP/UDP）：利用 TCP 攻击连接资源。利用 UDP 攻击网络带宽。
- 网络层（IP 协议）：攻击网络带宽。

只要是按照 IP 协议封装数据，不论链路层是什么（以太网、卫星网或其他物理实现的子网），都可以被正确发送。

ping 工作在网络层，用的是 ICMP 协议，ICMP 是 IP 协议中用来做差错控制的一个补充，本质是 IP 报。用 ICMP 攻击叫 ICMP 洪水。

UDP 可以发送做 UDP 洪水攻击，攻击者要考虑隐藏 IP——伪造 IP。

伪造 IP 是可行的：……

既然可以伪造 IP，又多了一种手段来“借刀杀人”，就是用被攻击者 IP 作为发起 IP，让所有接受者（称为“反射器”）响应到此 IP，以此达到攻击目的。

攻击的放大：如利用 DNS 放大攻击，一次 DNS 查询返回数据往往大于请求数据，专业名词叫“带宽放大因子（BAF）”。攻击者可以不断对 DNS 发起查询请求，并伪造了源 IP 是攻击目标的 IP，那么这种反射攻击就会产生 BAF 放大倍数的效果。

TCP 连接表大小优先，TCP 三次握手，发起方发起大量连接会占用服务器的连接表而无法响应后续的 TCP 连接请求，这叫做 TCP 洪水。由于三次握手的存在，无法伪造 IP 隐藏攻击者信息。

但攻击者可以不使用三次握手，而只使用握手的第一个 SYN 进行攻击，这就是 SYN 洪水。SYN 洪水攻击方只发送第一个握手 SYN，服务端的第二次握手收不到响应，就会占用服务端一个连接直到超时。攻击者可以伪造一个不存在的 IP 或直接不进行后续握手，达到这种效果。也可以伪造一个存在的 IP “祸水东引”。

TCP + 反射攻击，攻击者可以伪造攻击目标 IP 为发起 IP，向所有反射器发起 TCP 连接 SYN，这样大量的 SYN+ACK 就会从反射器发向攻击目标，但这种由于无法成功建立连接，所以还是属于攻击网络带宽。

TCP 的 RST 洪水攻击，利用 TCP 四次挥手做攻击，任意一方发送 RST 数据都可以强制切断连接，攻击方可以不断尝试伪造各种 IP，来攻击服务器，这样在伪造 IP 匹配到正常客户端 IP 后可以强制断开客户端和服务器的连接。这种方式更像是针对用户进行攻击，对服务器的影响较小。（如网游对战，影响对手 IP 和服务端的正常连接）

http 洪水攻击，如生成大量关键词做查询地址，消耗对方查询能力，如果查询使用到 IO 或计算，那么可以达到消耗服务器 IO 资源或计算资源的能力。http 是搭载 TCP 的，所以无法伪造 IP，但可以借助网络代理主机用不同主机（仍是真实 IP）多点发起攻击。

## 防

- 关键点一：防伪造 IP。因为伪造 IP 是 DDoS 的一项核心技术。
    - 方案一：在路由设备上 drop 掉非本网段内源 IP 的流量，那么伪造 IP 的流量就无法正常发出。
    - 方案二：真实源 IP 到达目标机与伪造的源 IP 到达目标机的网络路由路径肯定是不同的，如果路由能在 IP 地址的路径逻辑中检测到矛盾，可以过滤掉伪造 IP 的流量。
    - 不可行性：涉及到用户、服务商、设备商、监管商等各个方的合作，只有大型企业和机构才能实现。
- 保守方案：
  - 利用服务端的 Distributed 特性分散流量，
    - 如 CDN 技术将缓存资源分散到各个 CDN 节点（效果不够）。
    - 流量清洗：在服务器前架设一台流量清洗设备。如 TCP SYN 洪水，可以由清洗设备进行握手，只有握手成功后将正常连接交给后方服务器。流量清洗还能用于 http 攻击，http 攻击很难鉴别是正常流量还是异常，流量清晰设备配备了专业做流量清晰的服务商，他们有多年的经验积累，如建立 IP 信用库过滤 IP，如利用算法对流量进行模式识别进行过滤。
