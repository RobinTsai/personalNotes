# lk agents

- [AgentSessin](#agentsessin)
- [Agent](#agent)
- [Tasks](#tasks)
- [Tool](#tool)
- [Turn Detection 和打断](#turn-detection-和打断)
- [Text 和 Transcriptions](#text-和-transcriptions)

https://docs.livekit.io/agents/build/

LiveKit Agents 项目是基于 livekit SDK 写的一个 Agent 配置编排工具，可以自定义编排出合适的 AgentSession，AgentSession 是 Agent 的主要业务程序。

## AgentSessin

AgentSession 主要是一些配置项，其结构定义如下

```py
class AgentSession(rtc.EventEmitter[EventTypes], Generic[Userdata_T]):
    def __init__(
        self,
        *,
        turn_detection: NotGivenOr[TurnDetectionMode] = NOT_GIVEN,
        stt: NotGivenOr[stt.STT] = NOT_GIVEN,
        vad: NotGivenOr[vad.VAD] = NOT_GIVEN,
        llm: NotGivenOr[llm.LLM | llm.RealtimeModel] = NOT_GIVEN,
        tts: NotGivenOr[tts.TTS] = NOT_GIVEN,
        mcp_servers: NotGivenOr[list[mcp.MCPServer]] = NOT_GIVEN,
        userdata: NotGivenOr[Userdata_T] = NOT_GIVEN,
        allow_interruptions: bool = True,
        discard_audio_if_uninterruptible: bool = True,
        min_interruption_duration: float = 0.5,
        min_interruption_words: int = 0,
        min_endpointing_delay: float = 0.4,
        max_endpointing_delay: float = 6.0,
        max_tool_steps: int = 3,
        video_sampler: NotGivenOr[_VideoSampler | None] = NOT_GIVEN,
        user_away_timeout: float | None = 15.0,
        agent_false_interruption_timeout: float | None = 4.0,
        min_consecutive_speech_delay: float = 0.0,
        use_tts_aligned_transcript: bool = False,
        preemptive_generation: bool = False,
        conn_options: NotGivenOr[SessionConnectOptions] = NOT_GIVEN,
        loop: asyncio.AbstractEventLoop | None = None,
    ) -> None:
```

AgentSession 和 Livekit 的媒体流交互，是通过 RoomIO 处理的，AgentSession 启动的时候会自动创建一个 RoomIO 对象，所有与会的参与者都能够订阅。

自定义 RoomIO 可以手动控制输入和输出，以及控制 Agent 监听或响应哪个参与者。

## Agent

- `AgentSession.start()` 方法会传入 `Agent` 对象（初始 `Agent`）
- `Agent` 一直控制着会话信息，它包含了自定义提示词、工具和一些逻辑。
- 继承 `Agent` 类就定义了一个自定义的 Agent；也可以直接实例化一个 `Agent`
- `AgentSession.update_agent()` 可以动态更新活动的 `Agent`
- 在一些 [Tool] 函数调用（应该要用 `@function_tool()` 装饰）中返回 `Agent` 可以自动切换 `Agent`
- 它可以调用其他任务，或者将控制权交给另一个 agent。比如如下场景：单个会话中有多种角色、阶段、模式或功能

框架中还有 [Tasks] 的概念，这还是实验性的支持，可以临时控制会话完成指定的任务并返回结果。

## Tasks

[Tasks]:https://docs.livekit.io/agents/build/workflows/#tasks

[Tasks] 使用的场景如：通话开始时获取录音的授权；收集特定的结构化数据（地址、手机号等）；一个一个地回答一连串的问题；其他比较离散的任务。

定义任务

- 继承 `AgentTask` 类，同时指定返回类型（用 Python 的泛型）
- 使用 `on_enter` 方法开始任务与用户交互
- 使用 `complete` 方法设置结果
- Task 在定义后自动执行，必须在 AgentSession 中活动状态的上下文中创建（Task 将接管 session 直到有结果）

预构建任务

覆盖任何插件：可以通过在 Agent 或 AgentTask 中设置相应的属性覆盖任何插件（如覆盖 tts 变更坐席的声音等）

## Tool

[Tool]: https://docs.livekit.io/agents/build/tools/#return-value

LiveKit 允许创建自定义的工具库来扩展 Agent 的上下文，创建交互式体验及客服 LLM 限制。使用 Tool 可以：

- 生成语音：`session.say()` 或 `session.generate_say()`
- 在前端调用 RPC
- 移交控制权给其他 Agent
- 在上下文中检索会话信息
- 任何 python 函数可以做的事情
- 调用外部 API 或查找 RAG

> RAG，Retrieval-Augmented Generation，检索增强生成，是结合了信息检索和生成式 AI 的技术框架。
> 在生成模型生成回答之前，先从外部知识库中检索与问题相关的信息，再让模型基于检索信息进行回答。

使用

- Tool 函数定义可以用 `@function_tool` 装饰器来装饰，既可以是类外定义的函数，也可以是类内的
- 在类外定义的 Tool，可以在 Agent 的 `tools` 属性（数组）中引入
- 通过 `Agent.update_tools()` 更新工具，这是全量更新（可以通过 `agent.tools` 属性引用已创建的）
- 传入参数
- 返回值会再发送到 LLM 前自动转换为字符串，返回 None 默认完成 tool 工作，无需 LLM 回复
- 返回值中包含 Agent 实例相当于切换 Agent
- 要编程动态创建 Tool，可以使用 `function_tool` 函数而不是装饰器
- 高级用法：`function_tool` 中的参数 `raw_schema` 可以从 json 获取定义

## Turn Detection 和打断

这里 Turn Detection 是指和用交互的轮次检测，即检测什么时候开始监听用户说话，及什么时候开始响应。

多少 Turn Detection 是用 VAD 根据用户静音时间做检测的，Agent 用了启发式算法分析轮次的完成。

支持的 Turn Detection 模式：

- Turn Detection 模型，一种基于 VAD 和 STT 自定义的开放权重的模型
- 实时模型：如 OpenAI Realtime API
- VAD only
- STT 端点：使用选择供应商的 STT 返回的短句端点进行判断
- 手动控制：完全禁用自动模式

## Text 和 Transcriptions

本块介绍了用户在和 Agent 进行交互过程中，文本的格式信息有哪些交互及如何交互。

- 文本语音同步输出
- 通过文本发送 question
- 语音和文本交互的控制

AgentSession 默认启用了转录文本同步的功能：在执行 STT 时，转录的文本实时发布；以及 Agent 进行 TTS 时，音频和文本同步发布。（说到哪个字就输出哪个字）

通过 `AgentSession.start()` 参数中的 `room_output_options.sync_transcription` 控制是否开启，其会通过 `lk.transcription` 的 TextStream 类型的 DataChannel 发布出去的，其中信息中携带 `lk.transcribed_track_id` 表明 TrackID。

AgentSession 中可以监听 `conversation_item_added` 事件，获取输入或输出提交到聊天历史中的信息。

使用 TTS 自己的对齐转录（提供商支持）可以通过 `AgentSession.use_tts_aligned_transcript` 开启，使用此功能有可能丢失原始文本的某些格式。

`Agent.transcription_node()` 方法会在每个词播报前后记录时间信息。

从文本输入中获取用户 question 可以使用 `lk.chat` 的 TextStream 进行交互，如果正在说话中收到消息会触发打断。要禁用文本交互可以设置 `RoomInputOptions.text_enabled` 为 `False`。

如果要禁用语音交互（input/output），可以设置 `AgentSession.room_Xput_options.audio_enabled` 为 `False`，禁用语音交互后，文本响应不会携带 `lk.transcribed_track_id` 属性。

客户端要静音或关闭声音输出，可以使用 注册 RPC 操作 `session.Xput.set_audio_enabled()` 进行开关控制，这种情况不拆媒体流，而只是控制输入和输出内容（无声流）。

AgentSession 主动生成一个问题的响应，可以使用 `AgentSession.generate_reply(user_input="...")` 实现。
