# models

```py
Model.objects.get_or_create( filter_kwargs, defaults={} )     # get 或用 defaults 进行创建 
Model.objects.update_or_create( filter_kwargs, defaults={} )  # defaults 保证的是最终一致性
```

## queryset 查询方式

QuerySet 支持通过多种方式组合复杂查询条件，包括使用 Q 对象、F 表达式、聚合函数、子查询 

```py
from django.db.models import F
from django.db.models import Q
from django.db.models import Avg, Count, Max, Min, Sum # 聚合相关
from django.db.models import OuterRef, Subquery # 子查询
from django.db.models import Case, When, Value, IntegerField # 条件查询

# 查询：(name=john AND age>18) OR email=test@example.com
User.objects.filter(
    Q(name="john") & Q(age__gt=18) | Q(email="test@example.com")
)
# 查询：NOT (name=john AND age=20)
User.objects.filter(~Q(name="john") | ~Q(age=20))

# ---
# 查询：salary > bonus * 2
Employee.objects.filter(salary__gt=F('bonus') * 2)
# 查询：updated_at 比 created_at 晚 1 天以上
from datetime import timedelta
Article.objects.filter(updated_at__gt=F('created_at') + timedelta(days=1))

# ---
# 按部门分组，统计每个部门的平均工资和员工数
Department.objects.annotate(
    avg_salary=Avg('employee__salary'),
    employee_count=Count('employee')
)
# 计算所有订单的总金额
Order.objects.aggregate(total=Sum('amount'))  # 返回 {'total': 1000.0}

# ---
# 查询每个用户的最新订单
latest_orders = Order.objects.filter(user=OuterRef('pk')).order_by('-created_at')
User.objects.annotate(
    latest_order_date=Subquery(latest_orders.values('created_at')[:1])
)

# ---
# 根据用户等级设置折扣
User.objects.annotate(
    discount=Case(
        When(level=1, then=Value(0.1)),
        When(level=2, then=Value(0.2)),
        default=Value(0.05),
        output_field=IntegerField()
    )
)

# 跨表关联查询，用 __ 实现
# 查询所有作者为 "John" 的书籍
Book.objects.filter(author__name="John")

# 查询至少有 5 个评论的书籍
Book.objects.annotate(comment_count=Count('comments')).filter(comment_count__gte=5)

from django.db.models import Func, Value

# 使用 CONCAT 拼接字段
User.objects.annotate(
    full_name=Func(F('first_name'), Value(' '), F('last_name'), function='CONCAT')
)

# 使用 RawSQL
from django.db.models import TextField
User.objects.annotate(
    initials=RawSQL("SUBSTRING(first_name, 1, 1) || SUBSTRING(last_name, 1, 1)", [])
)

# 查询：(name=john OR name=alice) AND age>18 AND has_premium=True
User.objects.filter(
    Q(name="john") | Q(name="alice")
).filter(
    age__gt=18,
    has_premium=True
)
```
