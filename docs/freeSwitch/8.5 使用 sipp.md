# 使用 sipp

- [使用 sipp](#使用-sipp)
  - [基本参数](#基本参数)
  - [基本使用](#基本使用)
  - [对交互式页面的控制](#对交互式页面的控制)
    - [热键控制](#热键控制)
    - [命令控制](#命令控制)
    - [UDP 通信控制](#udp-通信控制)
  - [使用 xml 自定义场景](#使用-xml-自定义场景)
  - [关键字](#关键字)
  - [使用文件注入变量](#使用文件注入变量)
  - [mock 注册](#mock-注册)

---

sipp 可以用于生成一个或多个 SIP 呼叫到远端系统，命令行发起，实现 server 端或 client 端都可以。

- 参考: [SIPp 指导文档](https://sipp.sourceforge.net/doc/reference.html)
- docker: [ctaloi/docker-sipp](https://github.com/ctaloi/docker-sipp)

## 基本参数

- `-r` rate, 指定每秒呼叫个数
- `-rp` rate period in ms, 指定呼叫速率的时间（毫秒） `-r n -rp m` 表示每 m 毫秒呼叫 n 个
- `-bg` background mode，后台执行（发送信号 `SIGUSER1` 信号等同于 `q` 热键的优雅退出）
- `-l` 最大并发呼叫量
- `-m` 最大呼叫个数
- `-sf` 加载 xml 脚本
- `-sn` 使用内置脚本
- `-inf` 使用文件注入变量，参考下方 [使用文件注入变量](#使用文件注入变量)
- `-d` 指定 pause 参数的 duration 值，暂停脚本等待一段时间（单位毫秒）

基本 uac 可以使用这个命令 `docker run -it -v /tmp/webuser/robincai_tmp:/sipp ctaloi/sipp -sf uac.xml  192.168.1.112:8891 -s 057126207298  -m 1 -l 1 -d 20000`

## 基本使用

```sh
./sipp -sn uas              # 启动一个 server 端，默认启动在 5060 端口，会正确响应所有信令
./sipp -sn uac 127.0.0.1    # 启动一个 client 端，向 127.0.0.1:5060 发 invite；默认 user 是 sipp->service，默认每秒 10 个呼叫
```

## 对交互式页面的控制

有三种方式在打开的 sipp 进行控制：

- 1. 热键控制
- 2. 交互式命令控制
- 3. 通过通信（UDP）进行控制

### 热键控制

sipp 在交互式页面支持热键控制脚本的参数，如呼叫频率等。

| hot key | action                                                  |
| ------- | ------------------------------------------------------- |
| `+`/`-` | 增加/减少 1 个 rate_scale 的呼叫频率                    |
| `*`/`/` | 增加/减少 10 倍的 rate_scale 的呼叫频率                 |
| `p`     | 暂停和解除暂停                                          |
| `q`/`Q` | 退出（q 为优雅退出，Q 为立即退出，两次 q 等同于一次 Q） |
| 1~9     | 展示不同的统计页面（呼叫数量、响应分布）                |
| `c`     | 进入命令模式                                            |
| ...     |

### 命令控制

在 sipp 界面按快捷键 c 可以进入到命令模式。

| command                      | action             |
| ---------------------------- | ------------------ |
| `set rate X`                 | 设置速率（`+-&/`） |
| `set rate-scale X`           | 设置 rate scale    |
| `set limit X`                | 等同于 `-l` 参数   |
| `trace <log_level> <on/off>` | 开启日志级别       |
| ...                          |

### UDP 通信控制

每启动一个 sipp，会从 8888 端口开始占用，最多启动 60 个实例。因此可以向监听的 UDP socket 中发送 hot key 实现控制。

也可以发送 command 给 socket，command 前面紧邻加一个 `c` 字符即可


```sh
echo p | nc -u 127.0.0.1 8888 -q 1
echo 'cset rate 100' | nc -u 127.0.0.1 8888 -q 1
```

## 使用 xml 自定义场景

格式如下：

```xml
<!-- start with -->
<?xml version="1.0" encoding="ISO-8859-1" ?>
<scenario name="Basic Sipstone UAC">

<!-- content -->
<COMMAND ATTR="VALUE"> DATA </COMMAND>
<!-- or -->
<COMMAND ATTR="VALUE"/>
<!-- or -->
<COMMAND ATTR="VALUE">
    <action>
        ... <!-- some actions -->
    </action>
</COMMAND>

<!-- end with -->
</scenario>
```

- 开头和结尾固定
- 中间是内容，内容中包含三部分：命令、属性和值、文本数据
- 文本数据用 `<![CDATA[ ... ]]>` 包裹

通用的属性（ATTR）有

| 属性             | 值               | 描述                                                    |
| ---------------- | ---------------- | ------------------------------------------------------- |
| start_rtd        | 自定义名称       | 启动一个 Response Time Duration 计时器                  |
| rtd              | 名称             | 停止一个 RTD 计时器                                     |
| next             | 目的 label 的 id | 跳转到指定 label 处                                     |
| test             | 变量名           | 跟在 next 属性后使用时，当变量被设置后会跳转到 next 处  |
| chance           | 0-1 之间的数值   | 和 test 结合使用，当 test 满足时有 chance 的概率走 next |
| condexec         | 变量名           | 如果变量设置了，执行此动作                              |
| condexec_inverse | 变量名           | 如果变量未设置，执行此动作                              |
| counter          | 变量名           | 增加此变量的计数，conter 保存在统计文件中               |

可用的 COMMAND 有：

| COMMAND     | 属性 | 描述                             |
| ----------- | ---- | -------------------------------- |
| `<send>`    | ...  | 发送信令并设置一些属性                         |
| `<recv>`    | ...  | 设置期望，如收到一个信令、超时、收不到等 |
| `<pause>`   | ...  | 暂停指定的时间 |
| `<nop>`     | ...  | 期望收到一个信令或超时或收不到等 |
| `<recvCmd>` | ...  | 期望收到一个信令或超时或收不到等 |
| `<label>`   | ...  | 期望收到一个信令或超时或收不到等 |
| `<Response Time Repartition>`   | ...  | 期望收到一个信令或超时或收不到等 |
| `<Call Length Repartition>`   | ...  | 期望收到一个信令或超时或收不到等 |
| `<Globals>`   | ...  | 期望收到一个信令或超时或收不到等 |
| `<User>`   | ...  | 期望收到一个信令或超时或收不到等 |
| `<Reference>`   | ...  | 期望收到一个信令或超时或收不到等 |


## 关键字

参考 [SIPp - Keyword list](https://sipp.sourceforge.net/doc/reference.html)

- `[service]`，用 `-s` 指定
- `[local_ip]`，用 `-i` 指定

## 使用文件注入变量

用 `-inf` 可以使用文件注入变量。

文件的首行必须是 `SEQUENTIAL`（顺序读取）或 `RANDOM`（随机读取），余下行每行对应一个呼叫。

每个呼叫的配置，使用 `;` 对每一项参数进行分割，分开的项在脚本中使用方式为 `[field0],[field1],...[fieldn]`。

文件中用 `#` 开头的表示注释，会忽略加载。

## mock 注册

```sh
sipp -r 1 -i 0.0.0.0 -p 12690 -l 1000000 -sf reg.xml -inf reg.csv -trace_msg 106.15.177.44:5474
```

```csv
SEQUENTIAL
98952092511033;[authentication username=98952092511033 password=d998a26ecc60a2bd]
```

```xml
<?xml version="1.0" encoding="ISO-8859-1" ?><!DOCTYPE scenario SYSTEM "sipp.dtd">
<!-- You should have received a copy of the GNU General Public License -->
<!-- along with this program; if not, write to the -->
<!-- Free Software Foundation, Inc., -->
<!-- 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA -->
<!-- -->
<!-- Sipp default 'branchc' scenario. -->
<!-- -->
<scenario name="branch_client">
<send retrans="500">
<![CDATA[
REGISTER sip:[remote_ip] SIP/2.0
Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
From: [field0] <sip:[field0]@[remote_ip]:[remote_port]>;tag=[call_number]
To: [field0] <sip:[field0]@[remote_ip]:[remote_port]>
Call-ID: [call_id]
CSeq: 1 REGISTER
Contact: sip:[field0]@[local_ip]:[local_port]
Content-Length: 0
Expires: 360000
User-Agent: FPBX-2.11.0
]]>
</send>


<recv response="401" auth="true" next="1">
</recv>

<!-- send invite with authentication messages -->
<label id="1"/>
<send retrans="500">
<![CDATA[
REGISTER sip:[field0]@[remote_ip]:[remote_port] SIP/2.0
Via: SIP/2.0/[transport] [local_ip]:[local_port]
From: [field0] <sip:[field0]@[remote_ip]:[remote_port]>;tag=[call_number]
To: [field0] <sip:[field0]@[remote_ip]:[remote_port]>
Call-ID: [call_id]
CSeq: 2 REGISTER
Contact: sip:[field0]@[local_ip]:[local_port]
[field1]
Content-Length: 0
Expires: 360000
User-Agent: FPBX-2.11.0
]]>
</send>

<recv response="200" >
</recv>
<pause milliseconds="1000"/>

<!-- definition of the response time repartition table (unit is ms) -->
<ResponseTimeRepartition value="10, 20, 30, 40, 50, 100, 150, 200"/>
<!-- definition of the call length repartition table (unit is ms) -->
<CallLengthRepartition value="10, 50, 100, 500, 1000, 5000, 10000"/>
</scenario>
```
