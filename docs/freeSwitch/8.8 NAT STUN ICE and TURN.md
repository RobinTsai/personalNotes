# NAT STUN ICE and TURN

## NAT

- [参考文档](https://info.support.huawei.com/info-finder/encyclopedia/zh/NAT.html)
- 是什么：NAT 是一种地址转换技术，他可以将 IP 数据报文头中的 IP 地址转换为另一种地址，并通过转换端口号达到地址重用的目的
- 工作方式：当私网访问公网时，报文达到有 NAT 功能的网关设备后，网关设备可以将私网的 IP:PORT 转换成公网的 IP:PORT 转发出去
- 影响：NAT 解决了 IPv4 地址枯竭的问题，得到了广泛应用

> 注：早期的 NAT 指 Basic NAT，只支持地址转换，不支持端口转换，因此只能解决私网访问公网的问题，无法解决 IP 地址短缺问题。
> 后期的 NAT 主要指 NAPT（Network Address Port Translation），支持了端口转换，由此，多台私网主机可以共享同一个 IP 地址访问公网，真正解决了 IP 短缺问题。

## STUN

- [参考文档](https://info.support.huawei.com/info-finder/encyclopedia/zh/STUN.html)
- 名词解释：STUN，Session Traversal Utilities for NAT
- 背景：P2P（Point to Point）网络要求通信双方都能主动发起网络访问，但是 NAT 设备的存在阻断了这种访问。
- 泛化：为了解决 NAT 设备给 P2P 网络带来的问题，出现了一些适用于 P2P 网络的 NAT 穿越技术。如反向连接技术、应用层网关 ALG 技术、打洞技术（Hole Punching）、中间件技术等。
- 是什么：由 RFC 定义的网络协议，用于检测网络中是否存在 NAT 设备，并获取两个通信端点经 NAT 设备分配的 IP 和 PORT，然后在两通信端点间建立一条可穿越 NAT 的 P2P 连接（打洞）
- 作用：STUN 无需更改现有 NAT 设备，需要在组网中部署一台 STUN 服务器，所有通信数据通过 STUN 服务器进行交互
- 限制：对于对称性 NAT 等负责场景，STUN 无法解决，需要用 TURN 协议

## ICE

- Interactive Connectivity Establishment，交互式连接建立
- 是一个在 WebRTC 协议底部的框架，帮助客户端建立高效、稳定的 P2P 连接，解决 NAT 和防火墙问题。
- 主要工作流程：收集候选地址 => 连通性检查 => 选定最终地址
- STUN 是 ICE 框架中收集服务器反射候选地址的关键技术，为 ICE 提供了公网地址映射信息
- TURN 是 ICE 在无法建立 P2P 连接时的中继解决方案，为 ICE 提供中继候选地址

## TURN

- 名词解释：Traversal Using Relays around NAT，使用中继穿越 NAT
- 工作原理：客户端于 TURN 服务器建立连接 => TURN 服务为每个客户端分配一个地址映射 => TURN 将数据转发给目标
- 作用：是 STUN 协议的一个补充，集成了 STUN，当 STUN 不可用时使用
